{% extends 'base.html' %}
{% load static %}

{% block title %}Detector de Edad y Emoción{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/detector.css' %}">
{% endblock %}

{% block content %}
<div class="detector-container">
    <div class="detector-header">
        <h2>Detector de Edad y Emoción en Vivo</h2>
        <p>Analiza tu rostro para detectar tu edad y emoción actual</p>
    </div>

    <div class="video-container">
        <video id="video" autoplay></video>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <button id="capturar">Capturar</button>
    <div id="resultado"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultado = document.getElementById('resultado');
    const btn = document.getElementById('capturar');

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(e => {
            resultado.textContent = 'Error al acceder a la cámara: ' + e.message;
        });

    btn.addEventListener('click', () => {
        btn.disabled = true;
        resultado.textContent = "Procesando imagen...";

        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;
        canvas.width = videoWidth;
        canvas.height = videoHeight;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, videoWidth, videoHeight);

        canvas.toBlob(blob => {
            if (!blob) {
                resultado.textContent = 'Error: No se pudo capturar la imagen';
                btn.disabled = false;
                return;
            }

            const formData = new FormData();
            formData.append('imagen', blob, 'foto.jpg');

            fetch('/detectar/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultado.textContent = 'Error: ' + data.error;
                } else {
                    resultado.textContent = `Edad estimada: ${data.edad} años | Emoción: ${data.emocion}`;
                }
            })
            .catch(() => {
                resultado.textContent = 'Error al comunicarse con el servidor.';
            })
            .finally(() => {
                btn.disabled = false;
            });
        }, 'image/jpeg');
    });
</script>
{% endblock %}
