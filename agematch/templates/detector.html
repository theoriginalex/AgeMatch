{% extends 'base.html' %}
{% load static %}

{% block title %}Detector de Edad y Emoción{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/detector.css' %}">
{% endblock %}

{% block content %}
  <div class="detector-container">
    <div class="detector-header">
      <h2>Detector de Edad y Emoción en Vivo</h2>
      <p>Analiza tu rostro para detectar tu edad y emoción actual</p>
    </div>
    <a href="{% url 'estadisticas' %}" class="power-by-link">Power by <span class="text-success">EmoAge</span></a>

    <div class="video-container">
      <video id="video" autoplay></video>
      <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <button id="btnCapturar" onclick="capturar()">Capturar</button>
    <div id="resultado"></div>
    <div id="musica" class="spotify-iframe"></div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultado = document.getElementById('resultado');
    const musica = document.getElementById('musica');
    const btn = document.getElementById('btnCapturar');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(e => {
        resultado.textContent = 'Error al acceder a la cámara: ' + e.message;
      });

    function capturar() {
      btn.disabled = true;
      resultado.textContent = "Procesando imagen...";
      musica.innerHTML = "";

      // Set canvas size to match video
      const videoWidth = video.videoWidth;
      const videoHeight = video.videoHeight;
      canvas.width = videoWidth;
      canvas.height = videoHeight;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, videoWidth, videoHeight);

      // Convert to JPEG with quality 0.9
      canvas.toBlob(blob => {
        if (!blob) {
          resultado.textContent = 'Error: No se pudo capturar la imagen';
          btn.disabled = false;
          return;
        }

        const formData = new FormData();
        formData.append('imagen', blob, 'foto.jpg');

        fetch('{% url "detectar_emocion" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            resultado.textContent = 'Error: ' + data.error;
          } else {
            resultado.textContent = `Edad estimada: ${data.edad} años | Emoción: ${data.emocion}`;
            obtenerSpotifyPlaylist(data.emocion);
          }
        })
        .catch(() => {
          resultado.textContent = 'Error al comunicarse con el servidor.';
        })
        .finally(() => {
          btn.disabled = false;
        });
      }, 'image/jpeg');
    }

    function obtenerSpotifyPlaylist(emocion) {
      fetch(`/home/detector/spotify/playlist/?emocion=${emocion}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            resultado.textContent = 'No se encontró una playlist para esta emoción.';
            return;
          }

          const uri = data.spotify_uri;
          const genero = data.genero;

          fetch(`/home/detector/spotify/reproducir/?playlist_uri=${encodeURIComponent(uri)}`) 
            .then(res => res.json())
            .then(reproduccion => {
              console.log("Spotify dice:", reproduccion.mensaje || reproduccion.error);
            });

          mostrarMusicaSpotify(uri, genero);
        })
        .catch(err => {
          console.error("Error obteniendo playlist:", err);
          resultado.textContent = 'Error obteniendo playlist desde el servidor.';
        });
    }

    function mostrarMusicaSpotify(uri, genero) {
      const playlistId = uri.split(':').pop();
      const embedUrl = `https://open.spotify.com/embed/playlist/${playlistId}`;
      const linkUrl = `https://open.spotify.com/playlist/${playlistId}`;

      musica.innerHTML = `
        <h3>Género sugerido: ${genero}</h3>
        <iframe style="border-radius:12px"
                src="${embedUrl}"
                width="800"
                height="330"
                frameborder="0"
                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                loading="lazy">
        </iframe>
        <p style="text-align: center; margin: 1em 0;">
  <a href="${linkUrl}" target="_blank"
     style="
       display: inline-block;
       padding: 1px 16px;
       background-color: #1DB954;
       color: white;
       text-decoration: none;
       border-radius: 6px;
       font-size: 15px;
     ">
    Abrir en Spotify
  </a>
</p>

      `;
    }
  </script>
{% endblock %}
