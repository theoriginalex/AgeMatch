<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detector de Edad y Emoci贸n</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 40px;
    }
    video, canvas {
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    #resultado {
      margin-top: 15px;
      font-size: 1.2em;
      font-weight: bold;
    }
    #musica {
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2>Detector de Edad y Emoci贸n en Vivo</h2>

  <video id="video" width="320" height="240" autoplay></video>
  <br>
  <button id="btnCapturar" onclick="capturar()">Capturar</button>
  <div id="resultado"></div>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
  <div id="musica"></div>

  <script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const resultado = document.getElementById('resultado');
  const musica = document.getElementById('musica');
  const btn = document.getElementById('btnCapturar');

  //  Activar c谩mara
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(e => {
      resultado.textContent = 'Error al acceder a la c谩mara: ' + e.message;
    });

  //  Capturar imagen y detectar emoci贸n
  function capturar() {
    btn.disabled = true;
    resultado.textContent = "Procesando imagen...";
    musica.innerHTML = "";

    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(blob => {
      const formData = new FormData();
      formData.append('imagen', blob, 'foto.jpg');

      fetch('{% url "detectar_emocion" %}', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          resultado.textContent = 'Error: ' + data.error;
        } else {
          resultado.textContent = `Edad estimada: ${data.edad} a帽os | Emoci贸n: ${data.emocion}`;
          obtenerSpotifyPlaylist(data.emocion);  // Va al siguiente paso
        }
      })
      .catch(() => {
        resultado.textContent = 'Error al comunicarse con el servidor.';
      })
      .finally(() => {
        btn.disabled = false;
      });
    }, 'image/jpeg');
  }

  //  Buscar playlist seg煤n emoci贸n y reproducir
  function obtenerSpotifyPlaylist(emocion) {
    fetch(`/home/detector/spotify/playlist/?emocion=${emocion}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          resultado.textContent = 'No se encontr贸 una playlist para esta emoci贸n.';
          return;
        }

        const uri = data.spotify_uri;
        const genero = data.genero;

        // Reproducir en Spotify
      fetch(`/home/detector/spotify/reproducir/?playlist_uri=${encodeURIComponent(uri)}`) 
          .then(res => res.json())
          .then(reproduccion => {
            console.log("Spotify dice:", reproduccion.mensaje || reproduccion.error);
          });

        // Mostrar visualmente el iframe
        mostrarMusicaSpotify(uri, genero);
      })
      .catch(err => {
        console.error("Error obteniendo playlist:", err);
        resultado.textContent = 'Error obteniendo playlist desde el servidor.';
      });
  }

  //  Mostrar playlist en el DOM con iframe
  function mostrarMusicaSpotify(uri, genero) {
    const playlistId = uri.split(':').pop();
    const embedUrl = `https://open.spotify.com/embed/playlist/${playlistId}`;
    const linkUrl = `https://open.spotify.com/playlist/${playlistId}`;

    musica.innerHTML = `
      <h3>G茅nero sugerido: ${genero}</h3>
      <iframe style="border-radius:12px"
              src="${embedUrl}"
              width="320"
              height="180"
              frameborder="0"
              allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
              loading="lazy">
      </iframe>
      <p><a href="${linkUrl}" target="_blank">Abrir en Spotify</a></p>
    `;
  }
</script>

</body>
</html>
